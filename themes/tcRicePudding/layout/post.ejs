<%-partial('widgets/header', {}, {cache: true})%>

<article id="post" class="post-article">
  <header class="post-header">
    <section class="post-header-content">
      <h1><%=page.title%></h1>
      <p class="time">
          <i class="iconfont icon-rili iconfont-size"></i>
          <span>发表于</span>
          <time datetime="<%=date_xml(page.date)%>"> <%=date(page.date)%></time>
        <span class="split">|</span>
          <i class="iconfont icon-shijian iconfont-size"></i>
          <span>更新于</span>
          <time datetime="<%=date_xml(page.updated)%>"><%=date(page.updated)%></time>
      </p>
      <p class="tag">
        <% page.tags.each(function(tag){ %><a href="<%- url_for(tag.path) %>">#<%=tag.name%></a><% }) %>
      </p>
      <p class="world-statistics">
        <span>
          <i class="iconfont icon-wenben iconfont-size"></i>
          <span>字数总计：</span>
          <span><%=wordcount(page.content)%></span>
          <span>个</span>
        </span>
        <span class="split">|</span>
        <span>
          <i class="iconfont icon-yanjing iconfont-size"></i>
          <span>阅读时长：</span>
          <span><%=min2read(page.content)%></span>
          <span>分钟</span>
      </p>
    </section>
  </header>

  <section class="post-content">
    <div class="post-md-content">
      <%-page.content%>
      <div class="post-tool">
        <div class="reward" title="打赏作者">
          <i class="iconfont icon-dashang-01 iconfont-size"></i>
          <span>打赏作者</span>
          <div class="reward-dialog">
            <div class="title">您的打赏是我前进的动力</div>
            <div class="pay-box">
              <span>
                <div class="wechat"></div>
                <div class="pay-title">微信</div>
              </span>
              <span>
                <div class="alipay"></div>
                <div class="pay-title">支付宝</div>
              </span>
            </div>
          </div>
        </div>
        <div class="copy-link" onclick="copyPageUrl()" title="复制链接"><i class="iconfont icon-charulianjie iconfont-size"></i></div>
      </div>
    </div>
    <div class="post-right-aside">
      <%-partial('partials/personal-info')%>
      <%-partial('partials/toc')%>
    </div>
  </section>
  <script>
    const addTableWrap = () => {
      const tableList = document.querySelectorAll("#post :not(.highlight) > table, #post > table");
      (tableList||[]).forEach(item => {
        addWrap(item, "div", { class: "table-wrap" });
      });
    };

    // 滚动条滑动到相应位置导航栏显示高亮
    const checkScrollHandel = ()=> {
        let topHeight = $(window).scrollTop(); // 屏幕位置
        const allEl = [...document.getElementsByClassName('headerlink')];

        const activeEl =  allEl.find((el,inx)=>{
          const yOffset = 80; // a 标签的偏移量为 menu 的高度（menu浮动，高度塌陷）
          let upperLimit = el.parentElement.offsetTop - yOffset;
          let lowerLimit = allEl[inx+1]?.parentElement.offsetTop - yOffset || +Infinity;
          return upperLimit<topHeight && topHeight<lowerLimit;
        } );

        const hash = activeEl?.href.split('#')[1];
        [...$('.post-toc  a')].forEach(el=>{ $(el).removeClass('active') });
        $(`.post-toc  a[href='#${hash}']`).addClass('active');
    }

  document.addEventListener("DOMContentLoaded", function () {
    addTableWrap(); // 给表格外套一层标签，否则样式会被污染

    document.removeEventListener("scroll", checkScrollHandel);
    document.addEventListener("scroll",checkScrollHandel);
  });
  </script>
</article>

<%-partial('widgets/paginator')%>